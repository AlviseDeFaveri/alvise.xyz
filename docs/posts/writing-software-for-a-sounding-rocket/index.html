<!doctype html><html lang=en-us data-anim=none><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Under the hood of a rocket's on-board software</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=/main.min.9f1d025f12d1a674916339e3bc13d48411471799fb5a03bfa7b4bec265939d7c.css media=all><script type=text/javascript>var storedTheme=localStorage.getItem('theme')||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");if(storedTheme){document.documentElement.setAttribute('data-theme',storedTheme)}</script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><meta property="og:title" content="Under the hood of a rocket's on-board software"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://www.alvise.xyz/posts/writing-software-for-a-sounding-rocket/"><meta property="og:image" content="https://www.alvise.xyz/posts/writing-software-for-a-sounding-rocket/img/rocket_hu4073ee8aef9892d67bc29c854886ddec_1335935_400x0_resize_q75_box.jpg"><meta property="article:published_time" content="2022-01-21T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.alvise.xyz/posts/writing-software-for-a-sounding-rocket/img/rocket_hu4073ee8aef9892d67bc29c854886ddec_1335935_400x0_resize_q75_box.jpg"><meta name=twitter:title content="Under the hood of a rocket's on-board software"><meta name=twitter:description content="So, this year is going to be 5 years since I first joined Skyward Experimental Rocketry, a student association that designs and builds sounding rockets, and oh boy, it has been a hell of a ride! I&rsquo;ve learned a lot from this team, both from a technical and a human perspective, and I&rsquo;d like to give something back&mldr;"></head><body class=terminal><div class="container top-container"><div class=terminal-nav><header class=terminal-logo><div class="logo terminal-prompt"><a href=https://www.alvise.xyz/ class=no-style>alvise.xyz</a>:~/$</div></header><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li><a href=https://www.alvise.xyz/about/ typeof="ListItem">about/</a></li><li><span class=separator></span></li><li><button id=theme-toggle>üåìÔ∏é</button></li></ul></nav></div></div><div class=header-spacer></div><div class="container main-container animated fadeInUp faster"><h1 class=post-title>Under the hood of a rocket's on-board software</h1><div class="postpage-date date">üìÜ 21 Jan. 2022 ‚Ä¢ ‚åö ~11 min.</div><div class=post-content><figure><a href=https://www.skywarder.eu/blog/lynx-en/><img src=img/rocket.jpg.webp alt="Test launch in Roccaraso (üáÆüáπ). ¬© Skyward Experimental Rocketry, 2021"></a><figcaption><p>Test launch in Roccaraso (üáÆüáπ). ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><p>So, this year is going to be 5 years since I first joined <a href=https://skywarder.eu>Skyward Experimental Rocketry</a>, a student association that designs and builds sounding rockets, and oh boy, it has been a hell of a ride!</p><p>I&rsquo;ve learned a lot from this team, both from a technical and a human perspective, and I&rsquo;d like to give something back. So, to celebrate the fact that they&rsquo;ve just <a href=https://github.com/skyward-er>open-sourced</a> their on-board software (<strong>OBSW</strong>), I figured it would be fun to write something about what this software does and how we developed it.</p><p>I won&rsquo;t be diving into the nitty gritty implementation details here (I might do that in a separate post in the future): what I want to provide is a high-level overview of what the software has to do and what type of problems it has to face.</p><p>If you want to get your hands dirty, I&rsquo;d recommend you start from the following repositories:</p><ul><li><a href=https://github.com/skyward-er/skyward-boardcore>skyward-boardcore</a>, the common framework for all of our rockets, which includes drivers, shared components and some <a href=https://github.com/skyward-er/skyward-boardcore/wiki>documentation</a> too</li><li>Lynx&rsquo;s <a href=https://github.com/skyward-er/on-board-software>on-board software</a>, which is the actual code that runs on the rocket and is built on top of boardcore</li><li>Our fork of the <a href=https://github.com/skyward-er/miosix-kernel>Miosix real-time OS</a>, which provides multi-threading capabilities, a filesystem and other basic utilities with minimal overhead</li></ul><h1 id=some-context>Some context</h1><p>In this post I&rsquo;ll be talking specifically about our latest rocket, Lynx, which we built to participate to our first international competition ever: <a href=https://euroc.pt>EuRoc</a>, a newborn competition held in Portugal between students of technical universities from all around Europe.</p><p>The rules of this challenge are quite complex, but the <em>TL;DR</em> is that teams compete in categories, each characterized by:</p><ul><li>a <strong>target altitude</strong>, which can be 3km or 10km</li><li>an <strong>engine type</strong>, either solid, liquid or hybrid</li></ul><p>Lynx in particular is a relatively small rocket (2.5m x 21kg) competing in the 3km solid motor category.</p><h2 id=target-altitude>Target altitude</h2><p>Let&rsquo;s start from the <em>target altitude</em>: the idea is that the nearer your <strong>apogee</strong> (the highest point of the rocket&rsquo;s flight) is to the target altitude, the more points you gain. For example, if two teams are competing in the 3km category, and one reaches 2900m of maximum altitude while the other one reaches 3500m, the former will get more points, regardless of which one flew the highest.</p><p>Note that, in order to target an <em>exact</em> altitude, the rocket must be able to control somehow its speed in real-time and to predict the apogee, to decide whether it&rsquo;s going too fast or not. Needless to say, this can be quite challenging for a group of students, especially when dealing with rockets that will reach a peak speed of over 1000km/h, but here&rsquo;s where the fun part starts.</p><p>(By the way, our final apogee was 3076m AGL, so not bad at all üòâ.)</p><h2 id=launching-with-a-solid-motor>Launching with a solid motor</h2><p>For what concerns the specific characteristics of each engine type, the EuRoc guys made a <a href=https://www.instagram.com/p/CUhoVtkNmTi>great post</a> on this topic, so I won&rsquo;t dig too much into the details of it.</p><p>For Lynx, we went for the Aerotech M2000R (you can find all the specs on <a href=https://www.skywarder.eu/blog/lynx-en/>the Lynx page</a> on the team&rsquo;s website) this year, although we are preparing our own <a href=https://www.skywarder.eu/blog/chimaera-en/>hybrid motor</a> for future editions.</p><figure><img src=img/skyward-euroc21-ignition.png.webp alt="Preparation of the rocket before ignition. ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>Preparation of the rocket before ignition. ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><p>Our solid motor had the advantage that we bought it off-the-shelf, but one of the problems with solid motors is that <strong>you cannot control thrust</strong>: basically, once you kickstart the chemical reaction, you can&rsquo;t stop it. Also, the amount of total thrust provided will slightly vary between motors of the same exact type, since variations in the propellant and igniter can cause significant performance differences.</p><p>So, how do you even control this thing? Well, in short, you can&rsquo;t control the motor directly, but you can at least <strong>slow down the rocket</strong> if you use some external components. In our case, we designed a set of retractible <strong>aerobrakes</strong> that were controlled by the electronic system through servo motors. These aerobrakes can be opened or closed at different degrees to adapt to the current speed in real-time.</p><h1 id=the-role-of-the-on-board-software>The role of the on-board software</h1><p>Skyward develops and maintains all kinds of software: some is used for simulating the trajectory of the flight, other is used by Mission Control in the <strong>Ground Station</strong> during launch-day, and another part, the so-called <strong>on-board software</strong>, is a bunch of C++ code that gets actually executed <em>inside</em> the rocket.</p><p>But where <em>exactly</em> inside the rocket?</p><figure><img src=img/deathstack2.jpg.webp alt="Two components of the Death Stack, our on-board computer. ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>Two components of the Death Stack, our on-board computer. ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><h2 id=the-electronic-system>The Electronic System</h2><p>Our on-board computer, called the <em>Death Stack</em>, is arguably one of the most complex subsystems of the entire rocket. It is composed of four electronics boards (or <em>PCB</em>s) stacked one onto another. Its components are:</p><ul><li>The <strong>Analog Board</strong> that contains most of the sensors, including four analog pressure sensors, one digital pressure sensor, the nosecone detach pin and the launchpad detach pin (detects liftoff)</li><li>The <strong>RF+IMU Board</strong> that is equipped with a GPS receiver, an RF module (Xbee 868 MHz) used to communicate with the ground station, and IMU + magnetometer to estimate the current attitude of the rocket</li><li>The <strong>STM Board</strong>, which is the <em>brain</em> of the whole system and mounts an STM32 F4 MCU coupled with an external RAM and an external <em>Oscillator</em>, which provides a high-precision clock</li><li>The <strong>Power Board</strong> manages the power for all the electronics, both the high-voltage/current one (e.g. actuators) and the low-voltage logic</li></ul><p>Also, every event and sensor datapoint, as well as routine checks of the software and hardware, are logged to an <strong>SD Card</strong>, which is enclosed in a <em>black box</em> that is designed to resist any impact with the ground.</p><p>The <strong>Actuators</strong> electronics in our case is composed by servo-motors, used to drive the aerobrakes and the opening of the nosecone, and <a href=https://www.cypres.aero/sparepart/pulley-part/>Cypres cutters</a>, which are used for the deployment of the second parachute.</p><h2 id=mission-recap>Mission recap</h2><p>So, what does this complex electronics have to do in the end?</p><p>Well, in first approximation, what a sounding rocket does is very simple: go up very fast, reach apogee, deploy a parachute, come down (gently). Rockets like this are typically designed to carry some kind of <strong>payload</strong>, such as a scientific experiment or a small cubesat, but in our case we were just carrying a dummy payload, since our goal for this mission was to validate the rocket itself.</p><figure><img src=img/conops.png.webp alt="Phases of the rocket flight. ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>Phases of the rocket flight. ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><p>With a little less approximation, we can divide the flight into the following phases:</p><ol><li><strong>On-ground operations</strong>: this includes everything that needs to be done before the motor is started, such as instruments calibration to minimize measurements errors during flight and pre-flight checks (weather, rocket status, team - in short, everything that is in the so-called <strong>go/no-go checklist</strong>).</li><li><strong>Ignition</strong>: the rocket motor is started and, hopefully, the rocket detaches from the ground. The software needs to detect the <strong>Lift Off</strong> to start the control logic.</li><li><strong>Ascending phase</strong>: the motor continues providing thrust for a few seconds, and the rocket accelerates reaching a maximum vertical speed of over 1000km/h. In this phase, we are monitoring the state of the rocket and controlling its speed through the <em>aerobrakes</em>.</li><li><strong>Apogee & Descending phases</strong>: at the highest point of the flight we need to deploy the <strong>parachute</strong>, so that the rocket is able to land without crashing. In particular, we have two types of parachutes: a small <em>drogue</em> parachute, to slow down a bit the descent phase, and a <em>main</em> parachute, that slows down the rocket even more just right before the touchdown.</li></ol><h2 id=what-does-the-software-do>What does the software do?</h2><figure><img src=img/obsw_diagram.png.webp alt="Components of the on-board software (OBSW). ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>Components of the on-board software (OBSW). ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><p>While an extensive description of every single software component of our OBSW is out of the scope of this post, let me at least try to give you the gist of some of the things that the on-board software has to take care of, and the classes of problems that we typically face.</p><p><strong>1. Sensor sampling</strong></p><p>To be able to detect the current state of the rocket, and make correct predictions about the apogee, we have all sorts of sensors. Each has its own communication interface, that needs its own <strong>driver</strong>, and must be <em>sampled</em> at a high frequency with precise intervals, which is where our <a href=https://github.com/skyward-er/skyward-boardcore/blob/master/src/shared/sensors/SensorSampler.cpp>sensor sampler</a> comes at play.</p><p><strong>2. Logging</strong></p><p>All the information collected during the flight, both from the sensors and from the software itself, needs to be saved on an SD card for post-flight analysis. However, the <strong>latency</strong> of SD card writing operations can be quite high if you don&rsquo;t do them in batch, so you need to accumulate a certain amount of information and write it all together. To avoid the whole software from blocking every time we do this, we employ a variation of the <a href=https://en.wikipedia.org/wiki/Multiple_buffering>triple-buffering</a> technique.</p><p><strong>3. Telemetry and Telecommands</strong></p><p>Before and during the flight, we want to be able to check the status of the on-board electronics and send commands to the rocket from an RF interface, that must be able to send and receive data reliably over long distances. In our rocket, we employ an <strong>868MHz</strong> transceiver and we use the <a href=https://mavlink.io/en/>Mavlink</a> protocol to exchange messages between the ground station and the rocket. We also employ a simple hand-rolled compression routine to consume less bandwidth and stuff more data into our telemetry packets.</p><p><strong>4. Aerobrakes control and parachutes deployment</strong></p><p>One of the most sophisticated things that we do on the on-board software is real-time <strong>attitude estimation and apogee detection</strong> using <a href=https://en.wikipedia.org/wiki/Kalman_filter>Kalman filters</a>. Using the data coming from the sensors, we estimate the current position, speed, acceleration and spin of the rocket, calculate how much we need actuate the aerobrakes and detect the <em>apogee</em>, which is the moment in which we must open up the nosecone and deploy the first parachute. We also need to detect the right moment to deploy the main parachute, which is around 350m AGL.</p><p><strong>5. Sensor Calibration and Filtering</strong></p><p>To control the system in a reliable way, we have to take into account that real sensors suffer from all kind of non-ideal behaviors: bias, noise, spikes, non-linearity etc., and these non-idealities can depend from all kind of factors, such as the speed, acceleration or internal temperature of the rocket, or even the system&rsquo;s electromagnetic noise. For this reason, we need to <strong>characterize</strong> our sensors during the testing phase, <strong>calibrate</strong> them before liftoff and <strong>filter</strong> the values we read from them in real-time based on the calibration we made.</p><figure><img src=img/accel-euroc.png.webp alt="An example of the raw data coming out from the on-board accelerometers. ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>An example of the raw data coming out from the on-board accelerometers. ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><figure><img src=img/skyward-sensors-analysis.jpg.webp alt="Post-flight analysis of the on-board sensors recordings after one of our test flights. ¬© Skyward Experimental Rocketry, 2021" width=800><figcaption><p>Post-flight analysis of the on-board sensors recordings after one of our test flights. ¬© Skyward Experimental Rocketry, 2021</p></figcaption></figure><p><strong>6. Task scheduling</strong></p><p>Needless to say, these are quite a lot of tasks to do in parallel, so we have a custom multi-threaded, real-time <a href=https://miosix.org/>OS</a> that performs the scheduling according to each task&rsquo;s priority.
Internally, we used event-based communication between threads to support synchronization and avoid <a href=https://en.wikipedia.org/wiki/Deadlock>deadlocks</a>, which are the most feared enemy of any concurrent system&rsquo;s developer.</p><h2 id=design-principles>Design principles</h2><p>Some of the things you don&rsquo;t directly see when reading code is the reasoning that led to a specific design choice, so I&rsquo;d like to highlight some of those so-called &ldquo;non-functional requirements&rdquo; that guided us while designing and developing this software:</p><ul><li><strong>Safety</strong>: unsurprisingly, dealing with rockets, explosives and flying things that go very fast is <strong>dangerous</strong>. Duh! For this reason, the whole system has to be designed from the ground up thinking about how to minimize risks and failures, and this includes the hardware, the software, the assembly and the launch procedures.</li><li><strong>Performance</strong>: in our software we have <strong>hard timing requirements</strong> to meet, for example when sampling sensors or when calculating the current state of the rocket. Not being able to guarantee a routine termination in a certain time frame can cause anything from a wrong reading of the sensor to a modification of the trajectory due to early apogee detection and consequent nosecone activation.</li><li><strong>Testability</strong>: somewhat related to safety, but also to how we develop things, we need to clearly define borders between software components and separate them, so that they can be tested a hundred times as a unit before integrating them with the whole system. This has a big impact in the long run, and has definitely influenced many of our design decisions.</li><li><strong>On-boardability</strong>: You can measure this as the time that a newbie has to spend with someone supervising him before he can actively contribute to the project. This might seem minor compared to the other things we listed, but the reality is that, as an association, we have a huge turnover, and even highly motivated members normally spend not more than 2 or 3 years as active part of the association (we all have to graduate in the end). This means that sometimes good documentation, predictable APIs, uniform naming rules, a clear development process and this kind of stuff has proven to be as important as squeezing out the most that we can from the on-board electronics.</li></ul><h1 id=y-tho>Y tho?</h1><p>A question I generally get asked when talking about this kind of stuff is: <em>what&rsquo;s the point of building such a small rocket?</em></p><p>I think my personal answer is: <strong>to do something challenging</strong>. I genuinely think there is a great value in being part of a group of people that voluntarily tries to do difficult stuff in a way that can miserably fail, and with no real incentives other than the challenge itself (we don&rsquo;t get paid nor we earn extra university credits).</p><p>It&rsquo;s a tough journey, but the view from the top is amazing.</p><p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/0l8kpqQN11Y style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div>‚ö†Ô∏è Watch out for the audio!</p><p>A part from the personal aspect, there is obviously an <strong>educational aspect</strong> too, since a rocket is a complex system to design, and even just <em>managing</em> the team that has to realize it is a challenge in itself. These are the kind of things that you don&rsquo;t get exposed to a lot in university and can complement your education in a very useful way.</p><p>There&rsquo;s also a <strong>technological aspect</strong> to it, since having all sorts of budget, time and people constraints forces you to be creative in devising solutions to problems that might normally require millions to be spent, and having this coupled with a low technical debt and a team of highly motivated engineers can drive innovation in all sorts of crazy ways.</p><h1 id=whats-next>What&rsquo;s next?</h1><p>The future for Skyward looks bright, and I&rsquo;m sure we will perform even better in the next competitions.</p><p>If you want to know more about the project and the on-board software, a good place to start from is boardcore&rsquo;s <a href=https://github.com/skyward-er/skyward-boardcore/wiki>documentation</a>. Also, the <em>Software and Control Systems</em> team is always looking for sponsors as well as motivated people that want to do something cool while in university, so if you&rsquo;re willing to contribute to the association, don&rsquo;t hesitate to <a href=https://www.skywarder.eu/blog/contact_us-en/>get in touch</a> with the team.</p></div><footer class=footer><p>¬© 2022 Alvise de Faveri // Built with
<a href=https://gohugo.io/>Hugo</a> and
<a href=https://github.com/mrmierzejewski/hugo-theme-console/>Console</a></p></footer></div></body><script type=text/javascript>var toggle=document.getElementById("theme-toggle");toggle.onclick=function(){document.documentElement.setAttribute("data-anim","fast")
var currentTheme=document.documentElement.getAttribute("data-theme");var targetTheme=currentTheme==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",targetTheme)
localStorage.setItem("theme",targetTheme);};</script></html>