<!DOCTYPE html>
<html lang="en-us" data-anim="none">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>[Writeup] Some (Web) Assembly Required - alvise.xyz </title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="/main.min.e371aad5905387eae269072fbdf91d319d9f74dbe43e89daa4d5ba0393b59e2c.css" media="all">

    
    <script type="text/javascript">
      var storedTheme = localStorage.getItem('theme') || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      if (storedTheme) {
        document.documentElement.setAttribute('data-theme', storedTheme)
      } else {
        document.documentElement.setAttribute('data-theme', 'dark')
      }
    </script>

    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="[Writeup] Some (Web) Assembly Required" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.alvise.xyz/posts/picoctf-some-assembly-required/" />


<meta name="twitter:title" content="[Writeup] Some (Web) Assembly Required"/>
<meta name="twitter:description" content="I&rsquo;ve been looking at some old picoCTF challenges lately, this is the solve for one of them. It&rsquo;s a gentle introduction to decompilation and reversing, but with a spinkle of Web Assembly on top."/>

</head>
<body class="terminal">
      <div class="container top-container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <a class=home-btn href="https://www.alvise.xyz/">~/</a>

            
            </header>
              
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
              
              <li class="separator"></li>
              <li><button id="theme-toggle">ðŸŒ“ï¸Ž</button></li>
            </ul>
          </nav>
        </div>
    </div>

    <div class="container main-container" >
        
<h1>[Writeup] Some (Web) Assembly Required</h1>

Jan. 1, 0001


<br/><br/>
<p>I&rsquo;ve been looking at some old <a href="https://picoctf.org/">picoCTF</a> challenges lately, and I stumbled upon
a series of <a href="https://play.picoctf.org/practice/challenge/182?category=1&amp;page=3">WebAssembly challenges</a>
from picoCTF 2021.
Since I don&rsquo;t know much about WASM, I decided to try them out.</p>
<p>The first 3 challenges of the series can be completed pretty easily with manual reverse
engineering.</p>
<p>The fourth (and last) one requires a bit more effort, which
convinced my lazy ass to look for some actual <strong>tools</strong> to do the job instead of
just staring at the code until it told me what I wanted.</p>
<p>Indeed, a part from one <a href="https://larry.science/post/picoctf-2021/#some-assembly-required-4">incredibly brilliant solver</a>
that did not even reverse engineer the wasm code at all, most of the solutions
I found on the internet did most of the work manually, so maybe
this writeup can be useful to other noobs like me.</p>
<h1 id="challenges-1-3">Challenges 1-3</h1>
<p>The general setup for all the challenges in the series is the same: you are given
a link to a webpage that asks you to input the flag. If the flag is wrong, the page will display the message <code>Incorrect!</code>, otherwise it prints <code>Correct!</code>.</p>
<figure
style="max-width:530px;
"><img src="challenge-page.png"style=";;;
         "
    />
</figure>

<p>Looking at the sources in the browser&rsquo;s inspector, we see a <code>js</code> file
and a <code>wasm</code> blob on the client, so we start from there.</p>
<figure
style="max-width:730px;
"><img src="sources.png"style=";;;
         "
    />
</figure>

<h2 id="js-deobfuscation">JS Deobfuscation</h2>
<p>The javascript file is <strong>obfuscated</strong>: variable names look like hexadecimals (for example <code>const _0x2f65 = ...</code>) and instead of strings like <code>getElementById</code> we have a function that takes a number and performs some weird array lookup based on it. Seems complicated, but it&rsquo;s not.</p>
<p>Deobfuscating the script requires just some patience:
we can copy the script in an editor and simply find-replace the obfuscated names with some sensible ones. To speed up the work, we can use the browser console to print the array lookup for specific values.</p>
<p>What we end up after deobfuscation is something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#7f848e">//  ... Unimportant stuff here ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">function</span> <span style="color:#e06c75">onButtonPress</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">let</span> <span style="color:#e06c75">val</span> <span style="color:#56b6c2">=</span> <span style="color:#7f848e">// Get the value of the input field...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Call `copy_char()` on each char of the input.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> (<span style="color:#c678dd">let</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x0</span>; <span style="color:#e06c75">i</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">val</span>[<span style="color:#98c379">&#34;length&#34;</span>]; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">exports</span>[<span style="color:#98c379">&#34;copy_char&#34;</span>](<span style="color:#e06c75">val</span>[<span style="color:#98c379">&#34;charCodeAt&#34;</span>](<span style="color:#e06c75">i</span>), <span style="color:#e06c75">i</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Call `copy_char()` with the null terminator.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">exports</span>[<span style="color:#98c379">&#34;copy_char&#34;</span>](<span style="color:#d19a66">0x0</span>, <span style="color:#e06c75">val</span>[<span style="color:#98c379">&#34;length&#34;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Call `check_flag()` and display result.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">exports</span>[<span style="color:#98c379">&#34;check_flag&#34;</span>]() <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0x1</span> <span style="color:#56b6c2">?</span> <span style="color:#7f848e">// Set the result field...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><p><code>exports</code> contains the functions exported by the WASM module, so  basically the javascript file is calling <strong>two functions</strong> of the WASM blob:</p>
<ul>
<li><code>copy_char()</code> copies the input into the WASM memory</li>
<li><code>check_flag()</code> performs the check against the flag</li>
</ul>
<p>We have a client-side check! Let&rsquo;s start reversing it.</p>
<h2 id="wasm-reversing">WASM Reversing</h2>
<p>Chrome&rsquo;s dev tools are kind enough to disassemble the <code>wasm</code> binary into a <code>.wat</code> file (textual format) whenever we click on it.</p>
<p>Once we have the code in textual format, we can try to understand what it&rsquo;s doing. WASM is super simple, yet very tedious to reverse: this is an example of a snippet.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#7f848e"># Take the constant 0xFF.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">i32.const</span> <span style="color:#d19a66">255</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e"># Put it in $var26 (each variable is assigned once).
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">local.set</span> <span style="color:#e06c75">$var26</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e"># Get both $var25 and $var26.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">local.get</span> <span style="color:#e06c75">$var25</span>
</span></span><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">local.get</span> <span style="color:#e06c75">$var26</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e"># Perform a bitwise and between them.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">i32.and</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e"># Put the result into $var27.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">local.set</span> <span style="color:#e06c75">$var27</span>
</span></span></code></pre></div><p>This whole code corresponds to:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#e06c75">var27</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var25</span> <span style="color:#56b6c2">&amp;</span> <span style="color:#d19a66">0xFF</span>;
</span></span></code></pre></div><p>As you can imagine, reversing big chunks of code like this takes a while, but at least the semantics of each single instruction is kinda straightforward.</p>
<h1 id="challenge-4">Challenge 4</h1>
<p>As I said, I solved the first three challenges by hand, but the fourth one was a bit too much.</p>
<p>Downloading the <code>.wat</code> and checking for diffs from the previous versions reveals that the only change is in <code>check_flag()</code>, which is now ~800 lines long and contains a bunch of <code>goto</code> instructions. Reversing by hand seems like a waste of time.</p>
<h2 id="wabt">WABT</h2>
<p>A quick Google search finds this <a href="https://github.com/WebAssembly/wabt">WebAssembly Binary Toolkit</a> repository, which is exactly waht we need.</p>
<p>First, we copy the <code>.wat</code> code on a local file and use <code>wat2wasm</code> to produce a <code>wasm</code> binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wat2wasm picoCTF/chall.wat -o chall.wasm
</span></span></code></pre></div><p>Then, we can either use <code>wasm2c</code> to get the code translated to C or use <code>wat-decompile</code> to get an intermediate representation of the code that is more concise.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wasm2c picoCTF/chall.wasm -o chall.c
</span></span><span style="display:flex;"><span>wasm-decompile picoCTF/chall.wasm -o chall.ir
</span></span></code></pre></div><p>Both the options are useful, also for earlier challenges, but the code is still too verbose. This is what we get in C for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#e06c75">in</span> <span style="color:#61afef;font-weight:bold">strcmp</span>(<span style="color:#e06c75">global_0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">var_i0</span>  <span style="color:#56b6c2">=</span> <span style="color:#d19a66">255u</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_l19</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var_i0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_i0</span>  <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var_l18</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_i1</span>  <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var_l19</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_i0</span>  <span style="color:#56b6c2">&amp;=</span> <span style="color:#e06c75">var_i1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_l20</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var_i0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">var_i0</span>  <span style="color:#56b6c2">=</span> <span style="color:#e06c75">var_l4</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><p>The file is 16k lines long, and there&rsquo;s no easy way to reveal the secret at a first glance.</p>
<p>From a first glance, it seems like the input gets copied to the heap region in the WASM binary with <code>get_char()</code>, then it gets manipulated in-place with XORs by the <code>check_flag()</code> function, and finally the resulting string is compared with a constant string.</p>
<p>Our task is then simply to invert the operations of <code>check_flag()</code> and apply them to the constant string, which represents the obfuscated value of the flag.</p>
<h2 id="lazy-attempts">Lazy attempts</h2>
<p>Hoping for a quick solve, I tried copying the obfuscated flag to the region where the input would normally be copied to and execute the <code>check_flag()</code> function on that, to see if the xorring function was reversible out-of-the box. Unfortunately, this was not the case.</p>
<p>Out of curiosity, I also tried to ask Google&rsquo;s chat AI (<em>Bard</em>) to translate the WASM code to C and refactor the C code to make it more concise, but the input was too big and, even for smaller pieces of code, the output did not seem completely correct.</p>
<p>So, disgruntled and underwhelmed by the state of LLMs, I went back to the searchbar: surely, there must be someone in the world that wrote a <strong>WASM plugin for Ghidra</strong> or IDA!</p>
<h2 id="ghidra-ftw">Ghidra FTW</h2>
<p>It would be way cooler if this was the story of how I wrote a WASM plugin for the <a href="https://ghidra-sre.org/">Ghidra decompiler</a>, but in the end I found an already existing <a href="https://github.com/nneonneo/ghidra-wasm-plugin">Ghidra plugin</a> that is well maintained, updated and working. <em>Nice!</em></p>
<p>Installing the plugin is straightforward, and after that if we import the <code>.wasm</code> file in Ghidra it gets automatically recognized.</p>
<p>After running the default analyses, we look at the <em>exports</em> in the symbol tree and find our target, <code>check_flag()</code>. Once we open it in the decompiled view, we can already see that the code is much more concise that the <code>wasm2c</code> output.</p>
<p><img src="ghidra.png" alt=""></p>
<p>At a glance, we already see that there are <strong>two separate loops</strong>, each with its own induction variable. Let&rsquo;s call them <code>i</code> and <code>j</code> to make the code more readable.</p>
<p>In the first loop, much of the code is computing <code>i + 0x430</code> and dereferencing the result. This is a strong indication that we are <strong>accessing an array</strong> based at 0x430.</p>
<p>We can verify this by double-clicking the constant, typing D to define an array of <code>uint_8[64]</code> and L to define a label (I called it <code>input</code>). Ghidra will restructure the C code to match this new information, and indeed we see that all that ugly pointer arithmetics is now gone.</p>
<p>Finally, we can condense <code>input[i] = input[i] ^ ...</code> to just <code>input[i] ^= ...</code>  where needed, and look at the <strong>final result</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#e06c75">byte</span> <span style="color:#e06c75">export</span><span style="color:#56b6c2">::</span><span style="color:#61afef;font-weight:bold">check_flag</span>(<span style="color:#e5c07b">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">uint8_t</span> <span style="color:#e06c75">uVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">j</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">byte</span> <span style="color:#e06c75">local_5</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#7f848e">// LOOP 1.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#c678dd">for</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">!=</span> <span style="color:#98c379">&#39;\0&#39;</span>; <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x14</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Hmm....
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">0</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x42f</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">2</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x42d</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> (<span style="color:#e06c75">byte</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">2</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">9</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">8</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">7</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">6</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#7f848e">// LOOP 2.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#c678dd">for</span> (<span style="color:#e06c75">j</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">j</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>; <span style="color:#e06c75">j</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> ((<span style="color:#e06c75">j</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">2</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) <span style="color:#56b6c2">&amp;&amp;</span> (<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">j</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">j</span>] <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">uVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#7f848e">// Compare with the obfuscated flag.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">iVar2</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">strcmp</span>((<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">*</span>)<span style="color:#d19a66">0x400</span>,(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">*</span>)<span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#7f848e">// Return 0 if the strcmp returned &gt; 0 (i.e. they are
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#7f848e">// not the same string).
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#c678dd">return</span> (<span style="color:#e06c75">iVar2</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span> <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0xffU</span>) <span style="color:#56b6c2">&amp;</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I have to say, this is even better that what I expected!</p>
<p>We can clearly see what the two loops are doing: the first loop is just <strong>xorring</strong> each character of the input with a bunch of constants and saving the result to the same position. The second loop is simply <strong>exchanging</strong> characters at even positions with their successor.</p>
<p>Since XOR is reversible, i.e. if <code>A ^ B = C</code> then <code>C ^ B = A</code>, and permutations are reversible, computing the inverse function is trivial.</p>
<p>The plan is simple:</p>
<ol>
<li>Take the obfuscated flag from the WASM binary&rsquo;s memory</li>
<li>Execute <em>LOOP 2</em> (moves each char back to its position)</li>
<li>Execute <em>LOOP 1</em> (XORs everything again to reveal the flag)</li>
</ol>
<h2 id="one-small-detail">One Small Detail</h2>
<p>There is one minor thing that we need to pay attention to, which are these two operations inside <em>LOOP 1</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">0</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x42f</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">2</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#56b6c2">::</span><span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x42d</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Again, there is some constant that is added to the induction variable and then dereferenced, but it is unlikely that this is another array, because it would overlap with the previous one.</p>
<p>Going back to the original wasm, we see that this is most likely an <strong>artifact of decompilation</strong>: <code>0x42f</code> and <code>0x42d</code> are the result of <code>0x430 - 1</code> and  <code>0x430 - 3</code>.</p>
<p>By keeping this in mind we can, for example, rewrite the memory access in the first operation as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>   <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x42f</span>)
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">=&gt;</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x430</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">=&gt;</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)(<span style="color:#d19a66">0x430</span> <span style="color:#56b6c2">+</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">1</span>))
</span></span></code></pre></div><p>Which is simply accessing the same array but with index <code>i-1</code>. The two operations of <em>LOOP 1</em> then become:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">0</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>];
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">2</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#e06c75">input</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">3</span>];
</span></span></code></pre></div><p>Basically, we are xorring each value of the with some preceding value as well.</p>
<p>With a bit of pen and paper it&rsquo;s easy to demonstrate that, if we want to invert these operations, the right way of doing it is traversing LOOP 1 <strong>backwards</strong>.</p>
<h2 id="flag-at-last">Flag, at last!</h2>
<p>After putting everything together, this is the final solution. The flag was copy-pasted from the <code>wasm2c</code> output produced before.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;stdint.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;stdio.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Obfuscated flag found in the WASM blob.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e5c07b">uint8_t</span> <span style="color:#e06c75">flag</span>[] <span style="color:#56b6c2">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#d19a66">0x18</span>, <span style="color:#d19a66">0x6a</span>, <span style="color:#d19a66">0x7c</span>, <span style="color:#d19a66">0x61</span>, <span style="color:#d19a66">0x11</span>, <span style="color:#d19a66">0x38</span>, <span style="color:#d19a66">0x69</span>, <span style="color:#d19a66">0x37</span>, <span style="color:#d19a66">0x1e</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d19a66">0x5f</span>, <span style="color:#d19a66">0x7d</span>, <span style="color:#d19a66">0x5b</span>, <span style="color:#d19a66">0x68</span>, <span style="color:#d19a66">0x4b</span>, <span style="color:#d19a66">0x5d</span>, <span style="color:#d19a66">0x3d</span>, <span style="color:#d19a66">0x02</span>, <span style="color:#d19a66">0x18</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d19a66">0x14</span>, <span style="color:#d19a66">0x7b</span>, <span style="color:#d19a66">0x65</span>, <span style="color:#d19a66">0x36</span>, <span style="color:#d19a66">0x45</span>, <span style="color:#d19a66">0x5d</span>, <span style="color:#d19a66">0x28</span>, <span style="color:#d19a66">0x5c</span>, <span style="color:#d19a66">0x33</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d19a66">0x45</span>, <span style="color:#d19a66">0x09</span>, <span style="color:#d19a66">0x39</span>, <span style="color:#d19a66">0x56</span>, <span style="color:#d19a66">0x44</span>, <span style="color:#d19a66">0x42</span>, <span style="color:#d19a66">0x7d</span>, <span style="color:#d19a66">0x3b</span>, <span style="color:#d19a66">0x6f</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d19a66">0x40</span>, <span style="color:#d19a66">0x57</span>, <span style="color:#d19a66">0x7f</span>, <span style="color:#d19a66">0x0e</span>, <span style="color:#d19a66">0x59</span>, <span style="color:#d19a66">0x00</span>, <span style="color:#d19a66">0x00</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#c678dd">const</span> <span style="color:#e5c07b">uint8_t</span> <span style="color:#e06c75">flag_len</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">41</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Reverse of LOOP 1.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">undo_xor</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Visit the array in reverse order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> (<span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">flag_len</span>; <span style="color:#e06c75">i</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">--</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x14</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// XOR with previous values.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#d19a66">0</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#d19a66">2</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">3</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>]<span style="color:#56b6c2">^=</span> (<span style="color:#e06c75">byte</span>)(<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Even/Odd.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">2</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">9</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Multiples of 3.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">7</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">6</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Same of LOOP 2.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">undo_permute</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> (<span style="color:#e5c07b">int</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">j</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">flag_len</span>; <span style="color:#e06c75">j</span><span style="color:#56b6c2">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> ((<span style="color:#e06c75">j</span> <span style="color:#56b6c2">%</span> <span style="color:#d19a66">2</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) <span style="color:#56b6c2">&amp;&amp;</span> (<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">flag_len</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#e5c07b">int</span> <span style="color:#e06c75">tmp</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">j</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">j</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">j</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tmp</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">undo_permute</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">undo_xor</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">for</span> (<span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">flag_len</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;%c&#34;</span>, <span style="color:#e06c75">flag</span>[<span style="color:#e06c75">i</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And there we go, we have the ðŸš©.</p>
<h2 id="conclusions">Conclusions</h2>
<p>I am not sure that the Ghidra plugin already existed during the original CTF, without that it would have been an awful challenge I think.</p>
<p>But, done now, this is a nice little entry-level challenge for people approaching reverse engineering, especially to learn new tools and get a gentle introduction to Ghidra as well.</p>



        <footer class="footer">
  <p>Built with
    <a href="https://gohugo.io/">Hugo</a> and
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console</a>
  </p>
</footer>

    </div>
  </body>





<script type="text/javascript">
  var toggle = document.getElementById("theme-toggle");

  toggle.onclick = function() {
    document.documentElement.setAttribute("data-anim", "fast")

    var currentTheme = document.documentElement.getAttribute("data-theme");
    var targetTheme = currentTheme === "light" ? "dark" : "light";

    document.documentElement.setAttribute("data-theme", targetTheme)
    localStorage.setItem("theme", targetTheme);
  };
</script>
</html>
